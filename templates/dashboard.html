<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber Rides — Call Analytics Dashboard</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/c/cc/Uber_logo_2018.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'uber-black':    '#000000',
                        'uber-dark':     '#0a0a0a',
                        'neon-green':    '#00B35E',
                        'neon-blue':     '#0099BB',
                        'neon-purple':   '#7A1AB3',
                        'neon-pink':     '#B30050',
                        'neon-orange':   '#B3491F',
                        'electric-cyan': '#00A8B3',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes slide-in {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.4; }
        }

        body { background: #F7F7F7; }

        .card-uber {
            background: #FFFFFF;
            border: 1px solid #E5E5E5;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        .card-uber:hover {
            border-color: #000000;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }

        .stat-card { animation: slide-in 0.5s ease forwards; opacity: 0; }
        .stat-card:nth-child(1) { animation-delay: 0.05s; }
        .stat-card:nth-child(2) { animation-delay: 0.10s; }
        .stat-card:nth-child(3) { animation-delay: 0.15s; }
        .stat-card:nth-child(4) { animation-delay: 0.20s; }
        .stat-card:nth-child(5) { animation-delay: 0.25s; }

        .anim-card { animation: slide-in 0.5s ease forwards; opacity: 0; }

        .chart-container { position: relative; height: 260px; }

        /* Status badges — one colour per call status */
        .badge-success              { background: #F0FDF4; color: #00B35E; }
        .badge-hang-up              { background: #F5F5F5; color: #6B7280; }
        .badge-avoid-callback       { background: #FFFBEB; color: #D97706; }
        .badge-failed               { background: #FFF1F2; color: #DC2626; }
        .badge-not-the-right-person { background: #EFF6FF; color: #2563EB; }
        .badge-not-interested       { background: #FDF2F8; color: #B30050; }
        .badge-default              { background: #F3F3F3; color: #555555; }

        /* Human badge */
        .badge-yes { background: #FFF1F2; color: #DC2626; }
        .badge-no  { background: #F3F3F3; color: #777777; }

        /* Sentiment colours */
        .sentiment-satisfied { color: #00B35E; font-weight: 600; }
        .sentiment-neutral   { color: #0099BB; font-weight: 600; }
        .sentiment-upset     { color: #DC2626; font-weight: 600; }

        .table-row {
            border-bottom: 1px solid #F0F0F0;
            transition: background 0.15s;
        }
        .table-row:hover { background: #FAFAFA; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #F3F3F3; }
        ::-webkit-scrollbar-thumb { background: #D4D4D4; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #A3A3A3; }

        .live-dot {
            width: 8px; height: 8px;
            background: #00B35E;
            border-radius: 50%;
            animation: pulse-dot 2s ease-in-out infinite;
        }
        .header-bar {
            background: #000000;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- ===== HEADER ===== -->
    <header class="header-bar text-white px-6 py-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-screen-2xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/cc/Uber_logo_2018.png" alt="Uber" class="h-6 brightness-0 invert">
                <div class="w-px h-6 bg-gray-600"></div>
                <span class="text-white font-semibold text-lg tracking-tight">Call Analytics</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-gray-400 text-sm">
                    <div class="live-dot"></div>
                    <span>Live</span>
                </div>
                <span id="last-updated" class="text-gray-400 text-sm">—</span>
                <button onclick="loadAnalytics()" class="flex items-center gap-1.5 bg-white text-black text-sm font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                    Refresh
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto px-6 py-8 space-y-8">

        <!-- ===== SUMMARY CARDS ===== -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">

            <div class="card-uber stat-card p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Total Calls</span>
                    <div class="w-8 h-8 rounded-lg bg-black flex items-center justify-center">
                        <i data-lucide="phone-call" class="w-4 h-4 text-white"></i>
                    </div>
                </div>
                <p id="card-total" class="text-3xl font-black text-black">—</p>
            </div>

            <div class="card-uber stat-card p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Need Human</span>
                    <div class="w-8 h-8 rounded-lg bg-neon-pink flex items-center justify-center">
                        <i data-lucide="user-check" class="w-4 h-4 text-white"></i>
                    </div>
                </div>
                <p id="card-human" class="text-3xl font-black text-black">—</p>
            </div>

            <div class="card-uber stat-card p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Avg Attempts</span>
                    <div class="w-8 h-8 rounded-lg bg-neon-green flex items-center justify-center">
                        <i data-lucide="repeat" class="w-4 h-4 text-white"></i>
                    </div>
                </div>
                <p id="card-avg-attempts" class="text-3xl font-black text-black">—</p>
            </div>

            <div class="card-uber stat-card p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Avg Duration</span>
                    <div class="w-8 h-8 rounded-lg bg-electric-cyan flex items-center justify-center">
                        <i data-lucide="timer" class="w-4 h-4 text-white"></i>
                    </div>
                </div>
                <p id="card-avg-duration" class="text-3xl font-black text-black">—</p>
                <p class="text-xs text-gray-400 mt-1">seconds</p>
            </div>

            <div class="card-uber stat-card p-5" style="border-left: 3px solid #00B35E;">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Hours Saved</span>
                    <div class="w-8 h-8 rounded-lg bg-neon-green flex items-center justify-center">
                        <i data-lucide="clock" class="w-4 h-4 text-white"></i>
                    </div>
                </div>
                <p id="card-hours-saved" class="text-3xl font-black text-black">—</p>
                <p class="text-xs text-gray-400 mt-1">call + 2 min setup per call</p>
            </div>

        </div>

        <!-- ===== ROW 1: Status + Sentiment ===== -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="card-uber anim-card p-6" style="animation-delay:0.30s">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Call Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="card-uber anim-card p-6" style="animation-delay:0.35s">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Sentiment Distribution</h3>
                <div class="chart-container">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>

        </div>

        <!-- ===== ROW 2: Timeline + Top Phones ===== -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="card-uber anim-card p-6" style="animation-delay:0.40s">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Calls Over Time <span class="text-gray-400 font-normal normal-case">(last 30 days)</span></h3>
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>

            <div class="card-uber anim-card p-6" style="animation-delay:0.45s">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Top Phone Numbers</h3>
                <div class="chart-container">
                    <canvas id="phonesChart"></canvas>
                </div>
            </div>

        </div>

        <!-- ===== ROW 3: Duration Over Time (full width) ===== -->
        <div class="card-uber anim-card p-6" style="animation-delay:0.50s">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Avg Call Duration Over Time <span class="text-gray-400 font-normal normal-case">(last 30 days, seconds)</span></h3>
            <div class="chart-container" style="height: 220px;">
                <canvas id="durationTimeChart"></canvas>
            </div>
        </div>

        <!-- ===== ROW 4: Attempts + Handoff Rate ===== -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="card-uber anim-card p-6" style="animation-delay:0.55s">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Attempts Distribution</h3>
                <div class="chart-container">
                    <canvas id="attemptsChart"></canvas>
                </div>
            </div>

            <div class="card-uber anim-card p-6 flex flex-col items-center justify-center text-center" style="animation-delay:0.60s">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-6">Human Handoff Rate</h3>
                <p id="handoff-big" class="text-7xl font-black text-black mb-3">0%</p>
                <p class="text-gray-500 text-sm">of all calls escalated to a human agent</p>
                <div class="mt-6 w-full max-w-xs bg-gray-100 rounded-full h-2">
                    <div id="handoff-bar" class="h-2 rounded-full bg-neon-pink transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>

        </div>

        <!-- ===== RECENT CALLS TABLE ===== -->
        <div class="card-uber anim-card p-6" style="animation-delay:0.65s">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Recent Calls</h3>
                <span class="text-xs text-gray-400">Last 20 records</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b-2 border-gray-100 text-xs font-semibold text-gray-500 uppercase tracking-wide">
                            <th class="text-left pb-3 pr-4">#</th>
                            <th class="text-left pb-3 pr-4">Phone</th>
                            <th class="text-left pb-3 pr-4">Status</th>
                            <th class="text-left pb-3 pr-4">Sentiment</th>
                            <th class="text-left pb-3 pr-4">Human</th>
                            <th class="text-left pb-3 pr-4">Attempt</th>
                            <th class="text-left pb-3 pr-4">Duration</th>
                            <th class="text-left pb-3 pr-4">Time</th>
                            <th class="text-left pb-3">Summary</th>
                        </tr>
                    </thead>
                    <tbody id="recent-calls-body">
                        <tr>
                            <td colspan="8" class="py-10 text-center text-gray-400">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // ── Chart.js global defaults ──────────────────────────────────────────
        Chart.defaults.font.family = "'Inter', 'Arial', sans-serif";
        Chart.defaults.color = '#6B7280';
        Chart.defaults.animation = false;      // render instantly, no slide-in delay
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;

        // One colour per call status (matches CSS badges)
        const STATUS_COLORS = {
            'success':              '#00B35E',
            'hang up':              '#6B7280',
            'avoid callback':       '#D97706',
            'failed':               '#DC2626',
            'not the right person': '#2563EB',
            'not interested':       '#B30050',
        };

        // One colour per sentiment
        const SENTIMENT_COLORS = {
            'satisfied': '#00B35E',
            'neutral':   '#0099BB',
            'upset':     '#DC2626',
        };

        const COLOR_PALETTE = ['#000000', '#0099BB', '#00B35E', '#B30050', '#2563EB', '#D97706', '#00A8B3', '#6B7280'];

        // Chart instances (kept for in-place updates)
        let statusChart, sentimentChart, timeChart, phonesChart, attemptsChart, durationTimeChart;

        function buildDonut(canvasId, labels, data, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverOffset: 6 }]
                },
                options: {
                    cutout: '68%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 16, usePointStyle: true, pointStyleWidth: 10, boxHeight: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ` ${ctx.label}: ${ctx.parsed} (${Math.round(ctx.parsed / ctx.dataset.data.reduce((a, b) => a + b, 0) * 100)}%)`
                            }
                        }
                    }
                }
            });
        }

        function updateDonut(chart, labels, data, colors) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            if (colors) chart.data.datasets[0].backgroundColor = colors;
            chart.update('active');
        }

        // ── Status chart ──────────────────────────────────────────────────────
        function initStatusChart(dist) {
            const labels = Object.keys(dist).map(k => capitalise(k));
            const data   = Object.values(dist);
            const colors = Object.keys(dist).map(k => STATUS_COLORS[k.toLowerCase()] || '#888888');
            statusChart = buildDonut('statusChart', labels, data, colors);
        }

        // ── Sentiment chart ───────────────────────────────────────────────────
        function initSentimentChart(dist) {
            const labels = Object.keys(dist).map(k => capitalise(k));
            const data   = Object.values(dist);
            const colors = Object.keys(dist).map(k => SENTIMENT_COLORS[k.toLowerCase()] || '#888888');
            sentimentChart = buildDonut('sentimentChart', labels, data, colors);
        }

        // ── Calls over time ───────────────────────────────────────────────────
        function initTimeChart(rows) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rows.map(r => r.date),
                    datasets: [{
                        label: 'Calls',
                        data:  rows.map(r => r.count),
                        borderColor: '#000000',
                        backgroundColor: 'rgba(0,0,0,0.05)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#000000',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 7, maxRotation: 0 } },
                        y: { grid: { color: '#F0F0F0' }, beginAtZero: true, ticks: { precision: 0 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ── Top phones chart ──────────────────────────────────────────────────
        function initPhonesChart(rows) {
            const ctx = document.getElementById('phonesChart').getContext('2d');
            phonesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rows.map(r => r.phone),
                    datasets: [{
                        label: 'Calls',
                        data: rows.map(r => r.count),
                        backgroundColor: COLOR_PALETTE.slice(0, rows.length),
                        borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#F0F0F0' }, beginAtZero: true, ticks: { precision: 0 } },
                        y: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ── Attempts distribution chart ───────────────────────────────────────
        function initAttemptsChart(dist) {
            const ctx = document.getElementById('attemptsChart').getContext('2d');
            const labels = Object.keys(dist).map(k => `Attempt ${k}`);
            const data   = Object.values(dist);
            attemptsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Calls',
                        data,
                        backgroundColor: '#000000',
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: '#F0F0F0' }, beginAtZero: true, ticks: { precision: 0 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ── Avg duration over time chart ──────────────────────────────────────
        function initDurationTimeChart(rows) {
            const ctx = document.getElementById('durationTimeChart').getContext('2d');
            durationTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rows.map(r => r.date),
                    datasets: [{
                        label: 'Avg Duration (s)',
                        data:  rows.map(r => r.avg_duration),
                        borderColor: '#0099BB',
                        backgroundColor: 'rgba(0,153,187,0.08)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#0099BB',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 7, maxRotation: 0 } },
                        y: { grid: { color: '#F0F0F0' }, beginAtZero: true,
                             ticks: { callback: v => `${v}s` } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.y}s` } }
                    }
                }
            });
        }

        // ── Recent calls table ────────────────────────────────────────────────
        function renderTable(calls) {
            const tbody = document.getElementById('recent-calls-body');
            if (!calls.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-10 text-center text-gray-400">No calls yet.</td></tr>';
                return;
            }
            tbody.innerHTML = calls.map(c => {
                const statusBadge   = badgeClass(c.status);
                const humanBadge    = c.call_human ? '<span class="badge-yes px-2.5 py-1 rounded-full text-xs font-semibold">Yes</span>' : '<span class="badge-no px-2.5 py-1 rounded-full text-xs font-semibold">No</span>';
                const sentimentCls  = sentimentClass(c.sentiment);
                const summary       = (c.summary || '').length > 70 ? c.summary.slice(0, 70) + '…' : c.summary || '—';
                return `<tr class="table-row">
                    <td class="py-3 pr-4 text-gray-400 text-xs">${c.id}</td>
                    <td class="py-3 pr-4 font-mono text-xs font-semibold">${c.phone}</td>
                    <td class="py-3 pr-4"><span class="${statusBadge} px-2.5 py-1 rounded-full text-xs font-semibold">${capitalise(c.status)}</span></td>
                    <td class="py-3 pr-4 text-xs ${sentimentCls}">${capitalise(c.sentiment)}</td>
                    <td class="py-3 pr-4">${humanBadge}</td>
                    <td class="py-3 pr-4 text-xs text-center font-semibold">${c.attempt}</td>
                    <td class="py-3 pr-4 text-xs text-center font-mono">${formatDuration(c.duration)}</td>
                    <td class="py-3 pr-4 text-xs text-gray-400 whitespace-nowrap">${timeAgo(c.created_at)}</td>
                    <td class="py-3 text-xs text-gray-500 max-w-xs">${summary}</td>
                </tr>`;
            }).join('');
        }

        // ── Helpers ───────────────────────────────────────────────────────────
        function capitalise(s) {
            if (!s) return '—';
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function badgeClass(status) {
            const map = {
                'success':              'badge-success',
                'hang up':              'badge-hang-up',
                'avoid callback':       'badge-avoid-callback',
                'failed':               'badge-failed',
                'not the right person': 'badge-not-the-right-person',
                'not interested':       'badge-not-interested',
            };
            return map[(status || '').toLowerCase()] || 'badge-default';
        }

        function sentimentClass(sentiment) {
            const map = {
                'satisfied': 'sentiment-satisfied',
                'neutral':   'sentiment-neutral',
                'upset':     'sentiment-upset',
            };
            return map[(sentiment || '').toLowerCase()] || 'sentiment-neutral';
        }

        function formatDuration(secs) {
            if (!secs || secs === 0) return '0s';
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            return m > 0 ? `${m}m ${s}s` : `${s}s`;
        }

        function timeAgo(iso) {
            const diff = Date.now() - new Date(iso).getTime();
            const m = Math.floor(diff / 60000);
            if (m < 1)  return 'just now';
            if (m < 60) return `${m}m ago`;
            const h = Math.floor(m / 60);
            if (h < 24) return `${h}h ago`;
            return `${Math.floor(h / 24)}d ago`;
        }

        function updateLastRefreshed() {
            const now = new Date();
            document.getElementById('last-updated').textContent =
                `Updated ${now.toLocaleTimeString()}`;
        }

        // ── Main load function ────────────────────────────────────────────────
        let chartsInitialised = false;

        async function loadAnalytics() {
            try {
                const res = await fetch('/api/analytics');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const d = await res.json();

                // ── KPI cards: paint immediately (no chart work) ──────────────
                document.getElementById('card-total').textContent         = d.summary.total_calls.toLocaleString();
                document.getElementById('card-human').textContent         = d.summary.human_needed.toLocaleString();
                document.getElementById('card-avg-attempts').textContent  = d.summary.avg_attempts;
                document.getElementById('card-avg-duration').textContent  = d.summary.avg_duration;
                document.getElementById('card-hours-saved').textContent   = d.summary.total_hours_saved + 'h';
                document.getElementById('handoff-big').textContent        = d.summary.handoff_rate + '%';
                document.getElementById('handoff-bar').style.width        = Math.min(d.summary.handoff_rate, 100) + '%';
                updateLastRefreshed();

                // ── Charts + table ────────────────────────────────────────────
                try {
                    if (!chartsInitialised) {
                        initStatusChart(d.status_distribution);
                        initSentimentChart(d.sentiment_distribution);
                        initTimeChart(d.calls_over_time);
                        initPhonesChart(d.top_phones);
                        initAttemptsChart(d.attempts_distribution);
                        initDurationTimeChart(d.duration_over_time);
                        chartsInitialised = true;
                    } else {
                        updateDonut(statusChart,
                            Object.keys(d.status_distribution).map(capitalise),
                            Object.values(d.status_distribution),
                            Object.keys(d.status_distribution).map(k => STATUS_COLORS[k.toLowerCase()] || '#888888'));
                        updateDonut(sentimentChart,
                            Object.keys(d.sentiment_distribution).map(capitalise),
                            Object.values(d.sentiment_distribution),
                            Object.keys(d.sentiment_distribution).map(k => SENTIMENT_COLORS[k.toLowerCase()] || '#888888'));

                        timeChart.data.labels = d.calls_over_time.map(r => r.date);
                        timeChart.data.datasets[0].data = d.calls_over_time.map(r => r.count);
                        timeChart.update();

                        phonesChart.data.labels = d.top_phones.map(r => r.phone);
                        phonesChart.data.datasets[0].data = d.top_phones.map(r => r.count);
                        phonesChart.update();

                        attemptsChart.data.labels = Object.keys(d.attempts_distribution).map(k => `Attempt ${k}`);
                        attemptsChart.data.datasets[0].data = Object.values(d.attempts_distribution);
                        attemptsChart.update();

                        durationTimeChart.data.labels = d.duration_over_time.map(r => r.date);
                        durationTimeChart.data.datasets[0].data = d.duration_over_time.map(r => r.avg_duration);
                        durationTimeChart.update();
                    }
                } catch (chartErr) {
                    console.error('Chart render error:', chartErr);
                }
                renderTable(d.recent_calls);

            } catch (err) {
                console.error('Failed to load analytics:', err);
            }
        }

        // ── Boot ──────────────────────────────────────────────────────────────
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadAnalytics();
            setInterval(loadAnalytics, 30000);
        });
    </script>
</body>
</html>
